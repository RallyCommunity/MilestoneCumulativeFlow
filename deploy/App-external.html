<!DOCTYPE html>
<html>
<head>
    <title>MilestoneCFD</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.0/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CFDCalculator",{extend:"Rally.data.lookback.calculator.TimeSeriesCalculator",getMetrics:function(){return[{as:"Estimate",field:"Estimate",display:"area",f:"sum"}].concat(_.map(this.stateFieldValues,function(stateFieldValue){return{field:"PlanEstimate",as:stateFieldValue,f:"filteredSum",filterField:this.stateFieldName,filterValues:[stateFieldValue],display:"area"}},this))},_getPreliminaryEstimateById:_.memoize(function(preliminaryEstimate){return _.find(this.preliminaryEstimates,function(pe){return Rally.util.Ref.getRelativeUri(pe)===Rally.util.Ref.getRelativeUri(preliminaryEstimate)})}),_getChapterById:_.memoize(function(chapterId){return _.find(this.chapters,function(chapter){return chapter.getId()===chapterId})}),getDerivedFieldsOnInput:function(){var self=this;return[{as:"Estimate",f:function(snapshot){if(snapshot.State){var chapter=self._getChapterById(snapshot.ObjectID),preliminaryEstimate=self._getPreliminaryEstimateById(chapter.get("PreliminaryEstimate"));return Math.max(preliminaryEstimate.get("Value"),snapshot.LeafStoryPlanEstimateTotal||0)}return 0}}]},getSummaryMetricsConfig:function(){return[{as:"Estimate_max",f:function(seriesData){var max=0,i=0;for(i=0;seriesData.length>i;i++)seriesData[i].Estimate>max&&(max=seriesData[i].Estimate);return max}}]},getDerivedFieldsAfterSummary:function(){return[{as:"Ideal",f:function(row,index,summaryMetrics,seriesData){var max=summaryMetrics.Estimate_max,increments=seriesData.length-1,incrementAmount;return 0===increments?max:(incrementAmount=max/increments,Math.floor(100*index*incrementAmount)/100)},display:"line"}]},runCalculation:function(snapshots){var chartData=this.callParent(arguments),acceptedSeriesData=chartData.series[4].data,today=Rally.util.DateTime.toIsoString(new Date),endIndex=_.indexOf(chartData.categories,today.substring(0,today.indexOf("T"))),slope=(acceptedSeriesData[0]-acceptedSeriesData[endIndex])/(0-endIndex);return chartData.series.push({dashStyle:"Solid",name:"Actual",type:"line",data:_.map(chartData.categories,function(tick,i){return i*slope})}),chartData}});
                Ext.define("MilestoneApp",{extend:"Rally.app.App",componentCls:"app",margin:"10px",layout:{type:"vbox",align:"stretch"},items:[{xtype:"container",itemId:"header",layout:{type:"hbox",align:"stretch"}}],launch:function(){this.down("#header").add({xtype:"rallymilestonecombobox",width:200,height:22,stateful:!0,stateId:this.getContext().getScopedStateId("milestone"),context:this.getContext(),listeners:{ready:this._load,select:this._load,scope:this}})},_load:function(){Deft.Promise.all([this._loadMilestone(),this._loadChaptersInMilestone(),this._loadScheduleStateValues(),this._loadPreliminaryEstimateValues()]).then({success:function(){this._addProjectCheckboxes(),this._addChart()},scope:this})},_getMilestone:function(){return this.down("rallymilestonecombobox").getValue()},_loadMilestone:function(){var milestoneId=Rally.util.Ref.getOidFromRef(this._getMilestone());return Rally.data.ModelFactory.getModel({type:"Milestone",success:function(model){model.load(milestoneId,{fetch:["TargetDate"],callback:function(record){this.milestone=record},scope:this})},scope:this})},_loadChaptersInMilestone:function(){var store=Ext.create("Rally.data.wsapi.Store",{model:"portfolioitem/chapter",fetch:["ObjectID","Project","Name","PreliminaryEstimate","ActualStartDate","PlannedEndDate","AcceptedLeafStoryPlanEstimateTotal","LeafStoryPlanEstimateTotal"],filters:[{property:"Milestones",operator:"contains",value:this._getMilestone()}],context:{project:null},limit:1/0});return store.load().then({success:function(records){this.chapters=records},scope:this})},_loadPreliminaryEstimateValues:function(){var store=Ext.create("Rally.data.wsapi.Store",{model:"preliminaryestimate",fetch:["Name","Value"],limit:1/0});return store.load().then({success:function(records){this.preliminaryEstimates=records},scope:this})},_loadScheduleStateValues:function(){return Rally.data.ModelFactory.getModel({type:"UserStory",success:function(model){model.getField("ScheduleState").getAllowedValueStore().load({callback:function(records){this.scheduleStateValues=_.invoke(records,"get","StringValue")},scope:this})},scope:this})},_addProjectCheckboxes:function(){this.down("checkboxgroup")&&this.down("checkboxgroup").destroy();var teams=_.reduce(this.chapters,function(projects,chapter){return projects[Rally.util.Ref.getOidFromRef(chapter.get("Project"))]=chapter.get("Project"),projects},{});this.down("#header").add({xtype:"checkboxgroup",margin:"0 0 0 20px",height:22,flex:1,items:_.map(_.values(teams),function(team){return{boxLabel:team.Name,name:"project",inputValue:Rally.util.Ref.getOidFromRef(team),checked:!0}}),listeners:{change:this._addChart,scope:this}})},_addChart:function(){this.down("rallychart")&&this.down("rallychart").destroy(),this.add({xtype:"rallychart",flex:1,storeType:"Rally.data.lookback.SnapshotStore",storeConfig:this._getStoreConfig(),calculatorType:"CFDCalculator",calculatorConfig:{stateFieldName:"ScheduleState",stateFieldValues:this.scheduleStateValues,preliminaryEstimates:this.preliminaryEstimates,startDate:_.min(_.compact(_.invoke(this.chapters,"get","ActualStartDate"))),endDate:_.max(_.compact(_.invoke(this.chapters,"get","PlannedEndDate"))),chapters:this.chapters,enableProjects:!0},chartConfig:this._getChartConfig(),chartColors:["#848689"].concat(Rally.ui.chart.Chart.prototype.chartColors)})},_getStoreConfig:function(){return{find:{_TypeHierarchy:{$in:["HierarchicalRequirement","PortfolioItem/Chapter"]},_ItemHierarchy:{$in:_.invoke(this.chapters,"getId")},_ProjectHierarchy:{$in:Ext.Array.from(this.down("checkboxgroup").getValue().project)}},fetch:["ScheduleState","PlanEstimate","PortfolioItem","LeafStoryPlanEstimateTotal","State"],hydrate:["ScheduleState","State"],sort:{_ValidFrom:1},context:this.getContext().getDataContext(),limit:1/0}},_getChartConfig:function(){var totalAcceptedPoints=_.reduce(this.chapters,function(total,chapter){return total+chapter.get("AcceptedLeafStoryPlanEstimateTotal")},0),totalPoints=_.reduce(this.chapters,function(total,chapter){var leafPlanTotal=chapter.get("LeafStoryPlanEstimateTotal"),prelimEstValue=_.find(this.preliminaryEstimates,function(preliminaryEstimate){return Rally.util.Ref.getRelativeUri(preliminaryEstimate)===Rally.util.Ref.getRelativeUri(chapter.get("PreliminaryEstimate"))});return total+Math.max(leafPlanTotal,prelimEstValue.get("Value"))},0,this);return{chart:{zoomType:"xy"},title:{text:"Milestone Cumulative Flow"},subtitle:{text:Ext.Number.toFixed(100*(totalAcceptedPoints/totalPoints),2)+" % of "+totalPoints+" Total Points Completed"},xAxis:{tickmarkPlacement:"on",tickInterval:15,title:{text:"Date"}},yAxis:[{title:{text:"Points"}}],plotOptions:{series:{marker:{enabled:!1}},area:{stacking:"normal"}}}}});

            Rally.launchApp('MilestoneApp', {
                name:"MilestoneCFD",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
